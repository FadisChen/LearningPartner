<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPAS AI æ™ºæ…§å­¸ç¿’ä¸­å¿ƒ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <!-- Markmap -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib"></script>

    <!-- Google Generative AI -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Shepherd.js for Tour -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css" />
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

    <style>
        body {
            font-family: 'Outfit', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            overflow: hidden;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Markmap */
        #markmap-container svg {
            width: 100%;
            height: 100%;
        }

        /* Typing Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Markmap Node Cursor */
        .markmap-node {
            cursor: pointer !important;
        }

        /* Tour Customization */
        .shepherd-element {
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            border-radius: 12px;
        }

        .shepherd-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
        }

        .shepherd-text {
            font-size: 0.95rem;
            color: #475569;
        }

        .shepherd-button-primary {
            background: #2563eb !important;
            border-radius: 8px !important;
        }
    </style>
</head>

<body class="flex h-screen text-slate-800 overflow-hidden">

    <!-- Left Sidebar - Learning Center -->
    <aside class="glass flex flex-col border-r border-white/50 z-20 shadow-xl transition-all duration-300" id="sidebar"
        style="width: 320px;">
        <!-- Header with Collapse Button -->
        <div class="p-6 border-b border-white/50 flex justify-between items-center">
            <div class="flex-1 min-w-0">
                <h1
                    class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent whitespace-nowrap">
                    AI å­¸ç¿’ä¸­å¿ƒ
                </h1>
                <p class="text-xs text-slate-500 mt-1">iPAS AI æ‡‰ç”¨è¦åŠƒå¸«</p>
            </div>
            <div class="flex gap-2">
                <button onclick="app.startTour()" class="text-slate-400 hover:text-blue-500" title="é–‹å•Ÿæ•™å­¸">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
                <button onclick="app.toggleSidebar()" class="text-slate-400 hover:text-blue-500" title="æ”¶åˆå´é‚Šæ¬„">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Sidebar Content -->
        <div id="sidebarContent" class="flex-1 flex flex-col overflow-hidden">
            <!-- Settings: API Key & Model -->
            <div class="px-6 py-4 space-y-4">
                <!-- API Key -->
                <div id="apiKeySection" class="relative">
                    <label class="block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">Gemini API
                        Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="apiKeyInput" placeholder="è¼¸å…¥ API Key"
                            class="w-full bg-white/50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/50 transition-all placeholder:text-slate-400">
                        <button id="saveKeyBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-3 py-2 transition-colors shadow-lg shadow-blue-500/30">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <p id="keyStatus" class="text-[10px] text-slate-400 mt-1 pl-1">Key å„²å­˜æ–¼ç€è¦½å™¨æœ¬åœ°ç«¯</p>
                </div>

                <!-- Model Selector -->
                <div id="modelSection" class="relative">
                    <label class="block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">ä½¿ç”¨æ¨¡å‹ (Model
                        ID)</label>
                    <input type="text" id="modelInput" value="gemini-2.5-flash" placeholder="ä¾‹å¦‚: gemini-2.5-flash"
                        class="w-full bg-white/50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/50 transition-all font-mono text-slate-600">
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto px-4 space-y-2 py-2" id="subjectNav">
                <div class="space-y-1">
                    <label
                        class="block text-xs font-semibold text-slate-500 mb-2 px-2 uppercase tracking-wider">é¸æ“‡ç§‘ç›®</label>

                    <button onclick="app.switchSubject('subject1')" id="nav-subject1"
                        class="w-full text-left px-4 py-3 rounded-xl transition-all duration-200 flex items-center gap-3 group bg-white/40 hover:bg-white/80 border border-transparent hover:border-blue-200 shadow-sm">
                        <div
                            class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform font-bold">
                            1</div>
                        <div>
                            <div class="font-semibold text-sm">æ‡‰ç”¨è¦åŠƒ</div>
                            <div class="text-[10px] text-slate-500">äººå·¥æ™ºæ…§æŠ€è¡“</div>
                        </div>
                    </button>

                    <button onclick="app.switchSubject('subject2')" id="nav-subject2"
                        class="w-full text-left px-4 py-3 rounded-xl transition-all duration-200 flex items-center gap-3 group hover:bg-white/80 border border-transparent hover:border-green-200">
                        <div
                            class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center group-hover:scale-110 transition-transform font-bold">
                            2</div>
                        <div>
                            <div class="font-semibold text-sm">å¤§æ•¸æ“šåˆ†æ</div>
                            <div class="text-[10px] text-slate-500">è™•ç†èˆ‡æ‡‰ç”¨</div>
                        </div>
                    </button>

                    <button onclick="app.switchSubject('subject3')" id="nav-subject3"
                        class="w-full text-left px-4 py-3 rounded-xl transition-all duration-200 flex items-center gap-3 group hover:bg-white/80 border border-transparent hover:border-purple-200">
                        <div
                            class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center group-hover:scale-110 transition-transform font-bold">
                            3</div>
                        <div>
                            <div class="font-semibold text-sm">æ©Ÿå™¨å­¸ç¿’</div>
                            <div class="text-[10px] text-slate-500">æŠ€è¡“èˆ‡æ‡‰ç”¨</div>
                        </div>
                    </button>
                </div>

                <!-- Add New Subject Button -->
                <div class="mt-4 px-2">
                    <button onclick="document.getElementById('newSubjectUploader').click()"
                        class="w-full py-2 px-4 border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:text-blue-600 hover:border-blue-400 hover:bg-white/50 transition-all group">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="text-sm font-medium">æ–°å¢ç§‘ç›® (PDF -> MindMap)</span>
                    </button>
                    <input type="file" id="newSubjectUploader" accept="application/pdf" class="hidden">
                </div>

                <!-- File Upload Area for Current Subject -->
                <div class="mt-8 px-2" id="uploadSection">
                    <label class="block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">å­¸ç¿’æŒ‡å¼•
                        (Context)</label>
                    <div class="relative group">
                        <input type="file" id="pdfUploader" accept="application/pdf"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" disabled>
                        <div
                            class="bg-white/40 border-2 border-dashed border-slate-300 rounded-xl p-4 text-center transition-all group-hover:border-blue-400 group-hover:bg-white/60">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 mx-auto text-slate-400 mb-2 group-hover:text-blue-500" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="text-xs text-slate-600 font-medium" id="uploadText">é¸æ“‡ PDF æª”æ¡ˆ</p>
                            <p class="text-[10px] text-slate-400 mt-1">æä¾› AI åƒè€ƒæ–‡ä»¶</p>
                        </div>
                    </div>
                    <div id="fileStatus"
                        class="mt-2 text-[10px] text-emerald-600 font-medium hidden flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        <span>æª”æ¡ˆå·²è¼‰å…¥</span>
                    </div>
                </div>
            </nav>

            <!-- Footer -->
            <div class="p-4 border-t border-white/50 text-center">
                <p class="text-[10px] text-slate-400">Powered by Google Gemini</p>
            </div>
        </div>
    </aside>

    <!-- Collapsed Left Sidebar Button -->
    <button id="sidebarToggleBtn"
        class="hidden fixed left-0 top-1/2 -translate-y-1/2 z-30 bg-blue-600 text-white p-2 rounded-r-lg shadow-lg hover:bg-blue-700 transition-all"
        onclick="app.toggleSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd" />
        </svg>
    </button>

    <!-- Main Content - Knowledge Map (Always Visible) -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Map Title -->
        <div class="absolute top-4 left-4 z-10 pointer-events-none">
            <div class="glass rounded-xl px-4 py-2 shadow-lg pointer-events-auto">
                <h2 class="text-sm font-semibold text-slate-700">çŸ¥è­˜æ¶æ§‹åœ–</h2>
            </div>
        </div>

        <!-- Knowledge Map -->
        <div class="flex-1 w-full h-full bg-white/30 backdrop-blur-sm relative">
            <div class="w-full h-full" id="markmap-container">
                <svg id="markmap" class="w-full h-full"></svg>
            </div>

            <!-- Map Controls -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2 z-10">
                <div class="glass p-1.5 rounded-lg shadow-lg flex gap-1">
                    <button onclick="app.setFoldAll(false)"
                        class="p-2 hover:bg-blue-50 text-slate-600 rounded-md transition-colors" title="å…¨éƒ¨å±•é–‹">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button onclick="app.setFoldAll(true)"
                        class="p-2 hover:bg-blue-50 text-slate-600 rounded-md transition-colors" title="å…¨éƒ¨ç¸®åˆ">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="w-px h-6 bg-slate-200"></div>
                    <button onclick="app.fitMap()"
                        class="p-2 hover:bg-blue-50 text-slate-600 rounded-md transition-colors" title="é©åˆè¦–çª—å¤§å°">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Floating Node Action Context Menu -->
            <div id="nodeContextMenu"
                class="absolute hidden glass rounded-lg shadow-xl p-2 z-50 min-w-[150px] transform transition-all scale-95 opacity-0">
                <div class="text-xs font-bold text-slate-500 px-2 py-1 border-b border-slate-200 mb-1"
                    id="selectedNodeTitle">Topic</div>
                <button onclick="app.askAI('explain')"
                    class="w-full text-left px-2 py-1.5 text-sm hover:bg-blue-50 text-slate-700 rounded flex gap-2 items-center">
                    <span>ğŸ’¡</span> è§£é‡‹é€™å€‹æ¦‚å¿µ
                </button>
                <button onclick="app.askAI('quiz')"
                    class="w-full text-left px-2 py-1.5 text-sm hover:bg-green-50 text-slate-700 rounded flex gap-2 items-center">
                    <span>â“</span> å‡ºä¸€é¡Œè€ƒæˆ‘
                </button>
            </div>
        </div>
    </main>

    <!-- Right Sidebar - AI Tutor -->
    <aside class="glass flex flex-col border-l border-white/50 z-20 shadow-xl transition-all duration-300"
        id="chatSidebar" style="width: 400px;">
        <!-- Header with Collapse Button -->
        <div class="p-4 border-b border-white/50 flex justify-between items-center">
            <h2 class="text-lg font-bold text-slate-700">AI å°å¸«</h2>
            <button onclick="app.toggleChatSidebar()" class="text-slate-400 hover:text-blue-500" title="æ”¶åˆ AI å°å¸«">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                        clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <!-- Chat Content -->
        <div id="chatSidebarContent" class="flex-1 flex flex-col overflow-hidden">
            <!-- Chat Messages -->
            <div id="chatHistory" class="flex-1 overflow-y-auto px-4 py-4 space-y-4">
                <!-- Welcome Message -->
                <div class="flex gap-3">
                    <div
                        class="w-7 h-7 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex-shrink-0 flex items-center justify-center text-white font-bold text-xs">
                        AI</div>
                    <div
                        class="flex-1 bg-white rounded-2xl rounded-tl-none p-3 shadow-sm text-sm leading-relaxed text-slate-700 border border-slate-100">
                        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å°å¸«ã€‚æ­¡è¿ä¸Šå‚³å­¸ç¿’æŒ‡å¼• PDFï¼Œæˆ–é»æ“ŠçŸ¥è­˜æ¶æ§‹åœ–ä¸­çš„ä»»ä½•ä¸»é¡Œï¼Œè®“æˆ‘ç‚ºä½ è§£èªªï¼
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-white/50">
                <div class="relative glass rounded-xl shadow-lg p-2 flex gap-2 items-end">
                    <textarea id="chatInput" rows="1" placeholder="å•é»ä»€éº¼..."
                        class="flex-1 bg-transparent border-none focus:ring-0 text-slate-700 placeholder:text-slate-400 resize-none py-2 px-2 max-h-32 text-sm"></textarea>
                    <button onclick="app.sendMessage()" id="sendBtn"
                        class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-lg shadow-blue-500/30 transition-all disabled:opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path
                                d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </div>
                <p class="text-center text-[9px] text-slate-400 mt-2">AI å¯èƒ½æœƒçŠ¯éŒ¯ï¼Œè«‹ä»¥å®˜æ–¹æ•™æç‚ºæº–</p>
            </div>
        </div>
    </aside>

    <!-- Collapsed Right Sidebar Button -->
    <button id="chatSidebarToggleBtn"
        class="hidden fixed right-0 top-1/2 -translate-y-1/2 z-30 bg-purple-600 text-white p-2 rounded-l-lg shadow-lg hover:bg-purple-700 transition-all"
        onclick="app.toggleChatSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                clip-rule="evenodd" />
        </svg>
    </button>

    <!-- App Logic -->
    <script src="subjects.js"></script>
    <script>
        // --- FILE STORAGE (IndexedDB) ---
        const DEFAULT_FILES = {
            'subject1': 'AIæ‡‰ç”¨è¦åŠƒå¸«(ä¸­ç´š)-å­¸ç¿’æŒ‡å¼•-ç§‘ç›®1äººå·¥æ™ºæ…§æŠ€è¡“æ‡‰ç”¨è¦åŠƒ.pdf',
            'subject2': 'AIæ‡‰ç”¨è¦åŠƒå¸«(ä¸­ç´š)-å­¸ç¿’æŒ‡å¼•-ç§‘ç›®2å¤§æ•¸æ“šè™•ç†åˆ†æèˆ‡æ‡‰ç”¨.pdf',
            'subject3': 'AIæ‡‰ç”¨è¦åŠƒå¸«(ä¸­ç´š)-å­¸ç¿’æŒ‡å¼•-ç§‘ç›®3æ©Ÿå™¨å­¸ç¿’æŠ€è¡“èˆ‡æ‡‰ç”¨.pdf'
        };

        class FileStorage {
            constructor(dbName = 'LearningHubDB', storeName = 'files') {
                this.dbName = dbName;
                this.storeName = storeName;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onerror = (e) => reject(e);
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName); // Key is subjectId
                        }
                    };
                });
            }

            async save(subjectId, fileData) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put(fileData, subjectId);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e);
                });
            }

            async get(subjectId) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(subjectId);
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e);
                });
            }
        }

        // CORE APP
        const app = {
            currentSubject: 'subject1',
            apiKey: localStorage.getItem('gemini_key') || '',
            fileData: null,
            sidebarCollapsed: false,
            chatSidebarCollapsed: false,
            fileStorage: null,
            chatSessions: {}, // format: { subjectId: ChatSession }

            async init() {
                // Init File Storage
                this.fileStorage = new FileStorage();
                try {
                    await this.fileStorage.init();
                    console.log('FileStorage initialized');
                } catch (e) {
                    console.error('FileStorage init failed', e);
                }

                // UI Init
                this.updateAuthUI();

                // Initial load: Wait for storage init then switch subject
                this.switchSubject('subject1');

                // Load Model Preference
                const savedModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
                const modelInput = document.getElementById('modelInput');
                modelInput.value = savedModel;

                // Listeners
                document.getElementById('saveKeyBtn').addEventListener('click', () => this.saveKey());
                document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.saveKey();
                });

                document.getElementById('pdfUploader').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0]);
                });

                document.getElementById('modelInput').addEventListener('change', (e) => {
                    localStorage.setItem('gemini_model', e.target.value.trim());
                });

                const chatInput = document.getElementById('chatInput');
                chatInput.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('nodeContextMenu');
                    if (!menu.contains(e.target) && !e.target.closest('.markmap-node')) {
                        this.hideContextMenu();
                    }
                });

                // New Subject Uploader Listener
                document.getElementById('newSubjectUploader').addEventListener('change', (e) => {
                    this.handleNewSubjectUpload(e.target.files[0]);
                });

                // Auto Start Tour if no key
                setTimeout(() => {
                    if (!this.apiKey) {
                        this.startTour();
                    }
                }, 1000);
            },

            startTour() {
                if (this.tour) this.tour.complete();

                this.tour = new Shepherd.Tour({
                    useModalOverlay: true,
                    defaultStepOptions: {
                        classes: 'shadow-md bg-purple-dark',
                        scrollTo: true
                    }
                });

                this.tour.addStep({
                    id: 'intro',
                    text: 'æ­¡è¿ä½¿ç”¨ AI æ™ºæ…§å­¸ç¿’ä¸­å¿ƒï¼è®“æˆ‘å¸¶ä½ å¿«é€Ÿå°è¦½ã€‚',
                    attachTo: { element: '#sidebar', on: 'right' },
                    buttons: [{ text: 'ä¸‹ä¸€æ­¥', action: () => this.tour.next() }]
                });

                this.tour.addStep({
                    id: 'api-key',
                    text: 'é¦–å…ˆï¼Œåœ¨é€™è£¡è¼¸å…¥ä½ çš„ Gemini API Keyã€‚é€™æ˜¯ä½¿ç”¨ AI åŠŸèƒ½çš„å¿…è¦æ¢ä»¶ã€‚<br><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 underline">å–å¾— API Key</a>',
                    attachTo: { element: '#apiKeySection', on: 'right' },
                    buttons: [{ text: 'ä¸Šä¸€æ­¥', action: () => this.tour.back() }, { text: 'ä¸‹ä¸€æ­¥', action: () => this.tour.next() }]
                });

                this.tour.addStep({
                    id: 'subjects',
                    text: 'åˆ‡æ›ä¸åŒçš„è€ƒç§‘ï¼Œå³å´çš„çŸ¥è­˜åœ°åœ–æœƒéš¨ä¹‹æ›´æ–°ã€‚',
                    attachTo: { element: '#subjectNav', on: 'right' },
                    buttons: [{ text: 'ä¸Šä¸€æ­¥', action: () => this.tour.back() }, { text: 'ä¸‹ä¸€æ­¥', action: () => this.tour.next() }]
                });

                this.tour.addStep({
                    id: 'upload',
                    text: 'æœ€é‡è¦çš„æ­¥é©Ÿï¼š<b>ä¸Šå‚³è©²ç§‘ç›®çš„ PDF å­¸ç¿’æŒ‡å¼•</b>ã€‚AI æœƒè®€å–å…§å®¹ä¸¦æ ¹æ“šæ–‡ä»¶å›ç­”ä½ çš„å•é¡Œã€‚',
                    attachTo: { element: '#uploadSection', on: 'right' },
                    buttons: [{ text: 'ä¸Šä¸€æ­¥', action: () => this.tour.back() }, { text: 'ä¸‹ä¸€æ­¥', action: () => this.tour.next() }]
                });

                this.tour.addStep({
                    id: 'map',
                    text: 'è©¦è‘—é»æ“Šåœ°åœ–ä¸Šçš„<b>ä»»ä½•æ–‡å­—ç¯€é»</b>ï¼Œå¯ä»¥å« AI ç›´æ¥è§£é‡‹è©²æ¦‚å¿µæˆ–å‡ºé¡Œè€ƒä½ ï¼',
                    attachTo: { element: '#markmap-container', on: 'left' },
                    buttons: [{ text: 'äº†è§£äº†ï¼Œé–‹å§‹å­¸ç¿’ï¼', action: () => this.tour.complete() }]
                });

                this.tour.start();
            },

            saveKey() {
                const input = document.getElementById('apiKeyInput');
                if (input.value.trim().length > 10) {
                    this.apiKey = input.value.trim();
                    localStorage.setItem('gemini_key', this.apiKey);
                    this.updateAuthUI();
                } else {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key');
                }
            },

            updateAuthUI() {
                const input = document.getElementById('apiKeyInput');
                const status = document.getElementById('keyStatus');
                const uploader = document.getElementById('pdfUploader');

                if (this.apiKey) {
                    input.value = '';
                    input.placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (å·²å„²å­˜)';
                    status.textContent = 'API Key å·²å°±ç·’ âœ…';
                    status.className = 'text-[10px] text-green-500 mt-1 pl-1';
                    uploader.disabled = false;
                    document.getElementById('uploadText').textContent = 'é»æ“Šä¸Šå‚³ PDF';
                } else {
                    uploader.disabled = true;
                    document.getElementById('uploadText').textContent = 'è«‹å…ˆè¨­å®š API Key';
                }
            },

            switchSubject(id) {
                this.currentSubject = id;
                document.querySelectorAll('nav button').forEach(btn => {
                    btn.classList.remove('bg-blue-50', 'bg-green-50', 'bg-purple-50', 'border-blue-200', 'border-green-200', 'border-purple-200', 'shadow-sm');
                });
                const activeBtn = document.getElementById(`nav-${id}`);
                const color = SUBJECTS[id].color;
                activeBtn.classList.add(`bg-${color}-50`, `border-${color}-200`, 'shadow-sm');

                this.renderMap(SUBJECTS[id].markdown);

                // Try load from cache
                this.fileData = null;
                document.getElementById('fileStatus').classList.add('hidden');
                document.getElementById('uploadText').textContent = 'é»æ“Šä¸Šå‚³ PDF';
                document.getElementById('uploadText').classList.remove('text-blue-600', 'font-bold');

                if (this.fileStorage) {
                    this.fileStorage.get(id).then(data => {
                        if (data) {
                            this.fileData = data;
                            this.updateFileStatusUI(true, 'å·²å¾å¿«å–è¼‰å…¥æª”æ¡ˆ');
                        } else {
                            // No cache found, check if there is a suggested file
                            const suggestion = DEFAULT_FILES[id];
                            if (suggestion) {
                                document.getElementById('uploadText').textContent = `è«‹ä¸Šå‚³: ${suggestion}`;
                                document.getElementById('uploadText').classList.add('text-slate-500', 'text-xs');
                            }
                        }
                    });
                }

                // Switch Chat Session & Restore History
                this.loadChatSession(id);
            },

            loadChatSession(subjectId) {
                // Ensure session exists
                if (!this.chatSessions[subjectId]) {
                    this.chatSessions[subjectId] = {
                        history: [],  // UI history (for restoration)
                        modelHistory: [] // Google Generative AI Content format
                    };

                    // Add welcome message for new session
                    const welcomeMsg = { role: 'ai', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å°å¸«ã€‚æ­¡è¿ä¸Šå‚³å­¸ç¿’æŒ‡å¼• PDFï¼Œæˆ–é»æ“ŠçŸ¥è­˜æ¶æ§‹åœ–ä¸­çš„ä»»ä½•ä¸»é¡Œï¼Œè®“æˆ‘ç‚ºä½ è§£èªªï¼' };
                    this.chatSessions[subjectId].history.push(welcomeMsg);
                }

                // Clear current UI
                const container = document.getElementById('chatHistory');
                container.innerHTML = '';

                // Restore messages
                const session = this.chatSessions[subjectId];
                session.history.forEach(msg => {
                    this.renderChatMessage(msg.role, msg.text, msg.id);
                });
            },

            updateFileStatusUI(hasFile, msg) {
                const status = document.getElementById('fileStatus');
                const text = document.getElementById('uploadText');
                if (hasFile) {
                    status.classList.remove('hidden');
                    text.textContent = msg || 'æª”æ¡ˆå·²å°±ç·’';
                    text.classList.add('text-blue-600', 'font-bold');
                } else {
                    status.classList.add('hidden');
                    text.textContent = 'é»æ“Šä¸Šå‚³ PDF';
                    text.classList.remove('text-blue-600', 'font-bold');
                }
            },

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const toggleBtn = document.getElementById('sidebarToggleBtn');
                const sidebarContent = document.getElementById('sidebarContent');

                this.sidebarCollapsed = !this.sidebarCollapsed;

                if (this.sidebarCollapsed) {
                    sidebar.style.width = '0';
                    sidebar.style.padding = '0';
                    sidebarContent.style.display = 'none';
                    toggleBtn.classList.remove('hidden');
                } else {
                    sidebar.style.width = '320px';
                    sidebar.style.padding = '';
                    sidebarContent.style.display = '';
                    toggleBtn.classList.add('hidden');
                }
            },

            toggleChatSidebar() {
                const chatSidebar = document.getElementById('chatSidebar');
                const toggleBtn = document.getElementById('chatSidebarToggleBtn');
                const chatContent = document.getElementById('chatSidebarContent');

                this.chatSidebarCollapsed = !this.chatSidebarCollapsed;

                if (this.chatSidebarCollapsed) {
                    chatSidebar.style.width = '0';
                    chatSidebar.style.padding = '0';
                    chatContent.style.display = 'none';
                    toggleBtn.classList.remove('hidden');
                } else {
                    chatSidebar.style.width = '400px';
                    chatSidebar.style.padding = '';
                    chatContent.style.display = '';
                    toggleBtn.classList.add('hidden');
                }
            },

            renderMap(markdown) {
                const { Markmap, Transformer } = window.markmap;
                const transformer = new Transformer();
                const { root } = transformer.transform(markdown);
                this.root = root; // Save root for reuse

                // Default: Collapse All (Recursive)
                // This ensures that when expanding a node, its children remain closed
                const foldRecursively = (node) => {
                    node.payload = node.payload || {};
                    node.payload.fold = 1; // 1 = Folded
                    if (node.children) {
                        node.children.forEach(foldRecursively);
                    }
                };

                foldRecursively(this.root);

                if (this.mm) {
                    this.mm.setData(root);
                    this.mm.fit();
                } else {
                    this.mm = Markmap.create('#markmap', {
                        embedGlobalCSS: true,
                        scrollForPan: false,
                        zoom: true,
                        pan: true
                    }, root);

                    // Use event delegation to handle clicks on all nodes (including dynamically created ones)
                    const container = document.getElementById('markmap-container');
                    container.addEventListener('click', (e) => {
                        const node = e.target.closest('.markmap-node');
                        if (node) {
                            e.stopPropagation();
                            const text = node.textContent;
                            this.showContextMenu(e.pageX, e.pageY, text);
                        }
                    });
                }
            },

            setFoldAll(collapsed) {
                if (!this.mm || !this.root) return;

                const walk = (node) => {
                    node.payload = node.payload || {};
                    // If collapsing: fold=1. If expanding: fold=0.
                    node.payload.fold = collapsed ? 1 : 0;
                    if (node.children) {
                        node.children.forEach(walk);
                    }
                };

                walk(this.root);

                this.mm.setData(this.root);
                this.mm.fit();
            },

            fitMap() {
                if (this.mm) this.mm.fit();
            },

            showContextMenu(x, y, text) {
                this.selectedNode = text;
                const menu = document.getElementById('nodeContextMenu');
                document.getElementById('selectedNodeTitle').textContent = text.substring(0, 20) + (text.length > 20 ? '...' : '');
                menu.classList.remove('hidden');
                requestAnimationFrame(() => {
                    menu.classList.remove('scale-95', 'opacity-0');
                    menu.classList.add('scale-100', 'opacity-100');
                    menu.style.left = x + 'px';
                    menu.style.top = y + 'px';
                });
            },

            hideContextMenu() {
                const menu = document.getElementById('nodeContextMenu');
                menu.classList.add('scale-95', 'opacity-0');
                menu.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => menu.classList.add('hidden'), 200);
            },

            async handleFileUpload(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    this.fileData = {
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type // "application/pdf"
                        }
                    };

                    // Save to cache
                    if (this.fileStorage) {
                        this.fileStorage.save(this.currentSubject, this.fileData);
                    }

                    this.updateFileStatusUI(true, file.name);
                    this.addChatMessage('system', `æª”æ¡ˆ ${file.name} å·²è¼‰å…¥ä¸¦å¿«å–ï¼Œæ‚¨å¯ä»¥é–‹å§‹é‡å°å…§å®¹æå•ï¼`);
                };
                reader.readAsDataURL(file);
            },

            async handleNewSubjectUpload(file) {
                if (!file) return;
                if (!this.apiKey) {
                    alert('è«‹å…ˆè¨­å®š API Key');
                    this.startTour();
                    return;
                }

                const loadingId = 'loading-' + Date.now();
                this.addChatMessage('system', `æ­£åœ¨åˆ†æ ${file.name} ä¸¦ç”ŸæˆçŸ¥è­˜æ¶æ§‹åœ–ï¼Œè«‹ç¨å€™...`, loadingId);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    const filePart = {
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    };

                    const prompt = `
                        è«‹é–±è®€é€™ä»½æ–‡ä»¶ï¼Œä¸¦å°‡å…¶æ ¸å¿ƒå…§å®¹æ•´ç†æˆä¸€å€‹è©³ç´°çš„ Markdown æ ¼å¼çš„å¿ƒæ™ºåœ– (Mind Map)ã€‚
                        
                        è¦æ±‚ï¼š
                        1. æ ¹ç¯€é»æ˜¯æ–‡ä»¶çš„æ¨™é¡Œæˆ–ä¸»è¦ä¸»é¡Œã€‚
                        2. çµæ§‹è¦æ¸…æ™°ï¼ŒåŒ…å«ä¸»è¦ç« ç¯€å’Œé—œéµæ¦‚å¿µã€‚
                        3. ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
                        4. æ ¼å¼å¿…é ˆæ˜¯æ¨™æº–çš„ Markdown åˆ—è¡¨å½¢å¼ (ä½¿ç”¨ #, -, ç¸®æ’)ã€‚
                        5. ä¸éœ€è¦é–‹é ­çš„å•å€™èªæˆ–çµå°¾ï¼Œç›´æ¥è¼¸å‡º Markdown å…§å®¹ã€‚
                    `;

                    try {
                        const { GoogleGenerativeAI } = document.querySelector('script[type="importmap"]').textContent
                            ? { GoogleGenerativeAI: (await import('https://esm.run/@google/generative-ai')).GoogleGenerativeAI }
                            : window;

                        const genAI = new GoogleGenerativeAI(this.apiKey);
                        const model = genAI.getGenerativeModel({ model: document.getElementById('modelInput').value || 'gemini-2.5-flash' });

                        const result = await model.generateContent([filePart, prompt]);
                        const response = await result.response;
                        const text = response.text();

                        // Clean up markdown code blocks if present
                        const cleanMarkdown = text.replace(/```markdown/g, '').replace(/```/g, '').trim();

                        const title = file.name.replace('.pdf', '');


                        // Create subject and get ID
                        const newId = this.addNewSubject(title, cleanMarkdown);

                        // Save file context for the new subject
                        if (this.fileStorage) {
                            this.fileStorage.save(newId, filePart); // filePart structure matches
                        }

                        const loadingMsg = document.getElementById(loadingId);
                        if (loadingMsg) loadingMsg.innerHTML = `âœ… ${title} å·²æ–°å¢è‡³ç§‘ç›®åˆ—è¡¨ (æª”æ¡ˆå·²å¿«å–)ï¼`;

                        // Auto switch to new subject
                        this.switchSubject(newId);

                    } catch (err) {
                        const loadingMsg = document.getElementById(loadingId);
                        if (loadingMsg) loadingMsg.innerHTML = `<span class="text-red-500">ç”Ÿæˆå¤±æ•—: ${err.message}</span>`;
                        console.error(err);
                    }
                    // Reset input
                    document.getElementById('newSubjectUploader').value = '';
                };
                reader.readAsDataURL(file);
            },

            addNewSubject(title, markdown) {
                const id = 'subject-' + Date.now();
                // Pick a random color
                const colors = ['pink', 'orange', 'teal', 'indigo', 'cyan'];
                const color = colors[Math.floor(Math.random() * colors.length)];

                SUBJECTS[id] = {
                    title: title,
                    color: color,
                    markdown: markdown
                };

                // Add to Nav
                const nav = document.getElementById('subjectNav');
                const btn = document.createElement('button');
                btn.id = `nav-${id}`;
                btn.className = `w-full text-left px-4 py-3 rounded-xl transition-all duration-200 flex items-center gap-3 group hover:bg-white/80 border border-transparent hover:border-${color}-200`;
                btn.onclick = () => app.switchSubject(id);
                btn.innerHTML = `
                        <div class="w-8 h-8 rounded-lg bg-${color}-100 text-${color}-600 flex items-center justify-center group-hover:scale-110 transition-transform font-bold">New</div>
                        <div>
                            <div class="font-semibold text-sm">${title}</div>
                            <div class="text-[10px] text-slate-500">è‡ªå®šç¾©ç§‘ç›®</div>
                        </div>
                `;
                // Insert before the "Add New" button (last child is the div wrapper)
                // Actually the nav has direct buttons and a div wrapper at the end.
                // The structure is: 
                // <div class="space-y-1">...buttons...</div>
                // <div class="mt-4 px-2">...add button...</div>
                // Wait, the static HTML structure is:
                // <nav ...>
                //    <div class="space-y-1"> ... <selection buttons> ... </div>
                //    <div class="mt-4 px-2"> ... <add button> ... </div>

                const container = nav.querySelector('.space-y-1');
                container.appendChild(btn);

                return id;
            },



            async sendMessage() {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                if (!text) return;
                if (!this.apiKey) {
                    alert('è«‹å…ˆè¨­å®š API Key');
                    this.startTour();
                    return;
                }
                input.value = '';
                input.style.height = 'auto';

                this.addChatMessage('user', text);

                // Create AI bubble placeholder
                const aiBubbleId = 'ai-response-' + Date.now();
                this.addChatMessage('ai', '<span class="animate-pulse">...</span>', aiBubbleId);

                try {
                    await this.streamGemini(text, aiBubbleId);
                } catch (err) {
                    const bubble = document.getElementById(aiBubbleId); // Find the bubble content div
                    if (bubble) bubble.innerHTML += `<br><span class="text-red-500 text-xs">éŒ¯èª¤: ${err.message}</span>`;
                }
            },

            async askAI(mode) {
                this.hideContextMenu();
                let prompt = '';
                if (mode === 'explain') {
                    prompt = `è«‹è§£é‡‹ã€Œ${this.selectedNode}ã€é€™å€‹æ¦‚å¿µï¼Œç‰¹åˆ¥æ˜¯åœ¨ ${SUBJECTS[this.currentSubject].title} çš„é ˜åŸŸä¸­ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œç°¡å–®æ˜“æ‡‚ã€‚`;
                } else if (mode === 'quiz') {
                    prompt = `é‡å°ã€Œ${this.selectedNode}ã€é€™ä¸»é¡Œï¼Œè«‹å‡ºä¸€é¡Œå–®é¸é¡Œè€ƒæˆ‘ï¼Œä¸¦é™„ä¸Šç­”æ¡ˆè§£æã€‚ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚`;
                }

                this.addChatMessage('user', prompt);
                const aiBubbleId = 'ai-response-' + Date.now();
                this.addChatMessage('ai', '<span class="animate-pulse">...</span>', aiBubbleId);

                try {
                    await this.streamGemini(prompt, aiBubbleId);
                } catch (err) {
                    const bubble = document.getElementById(aiBubbleId);
                    if (bubble) bubble.innerHTML += `<br><span class="text-red-500 text-xs">éŒ¯èª¤: ${err.message}</span>`;
                }
            },

            async streamGemini(promptText, elementId) {
                const { GoogleGenerativeAI } = document.querySelector('script[type="importmap"]').textContent
                    ? { GoogleGenerativeAI: (await import('https://esm.run/@google/generative-ai')).GoogleGenerativeAI }
                    : window;

                const genAI = new GoogleGenerativeAI(this.apiKey);
                const modelInput = document.getElementById('modelInput');
                let modelName = modelInput.value.trim() || 'gemini-2.5-flash';

                // Get current session history
                const session = this.chatSessions[this.currentSubject];

                // Get chat model to resume state
                const model = genAI.getGenerativeModel({ model: modelName });

                // Construct history for startChat
                // Note: File data is best passed in the first proper user message of a session or context.
                // However, Google GenAI SDK allows `startChat` with history.
                // We need to inject the file context into the history if it's the first turn, or rely on system instruction (available in some models).
                // Simplified approach: New chat each time but send history manually? No, that's expensive.
                // Better approach: Use `startChat` and maintain the `chat` object instance?
                // JS objects are not persistent across reloads, but session.history is.
                // Let's reconstruct the chat history for the API call.

                const historyForApi = [...session.modelHistory]; // Clone

                // If this is the *very first* message in this session history and we have a file, prepending it might be tricky in chat mode.
                // Strategy: If fileData exists, and history is empty, the first message sent will include the file.
                // If history exists, we assume file context was already established or is not re-sent to save tokens (unless it allows caching).
                // For simplicity in this "Per Subject" mode: We will re-send file context if it's the first message of the session.

                let chat;
                if (historyForApi.length === 0 && this.fileData) {
                    // First turn with file
                    chat = model.startChat({
                        history: [
                            {
                                role: "user",
                                parts: [
                                    this.fileData,
                                    { text: "é€™æ˜¯æœ¬èª²ç¨‹çš„å­¸ç¿’æŒ‡å¼• PDFã€‚è«‹æ ¹æ“šé€™ä»½æ–‡ä»¶å›ç­”æˆ‘ä¹‹å¾Œçš„å•é¡Œã€‚" }
                                ]
                            },
                            {
                                role: "model",
                                parts: [{ text: "å¥½çš„ï¼Œæˆ‘å·²é–±è®€å­¸ç¿’æŒ‡å¼•ã€‚è«‹éš¨æ™‚æå•ï¼" }]
                            }
                        ]
                    });
                } else {
                    // Normal chat or subsequent turns
                    chat = model.startChat({
                        history: historyForApi
                    });
                }

                const result = await chat.sendMessageStream(promptText);

                let fullText = '';
                const bubbleContent = document.getElementById(elementId);

                for await (const chunk of result.stream) {
                    const chunkText = chunk.text();
                    fullText += chunkText;
                    if (bubbleContent) bubbleContent.innerHTML = window.marked.parse(fullText);

                    const historyDiv = document.getElementById('chatHistory');
                    historyDiv.scrollTop = historyDiv.scrollHeight;
                }

                // Update Session History
                session.modelHistory = await chat.getHistory();

                // Update UI History Tracking (last AI response)
                const lastAiMsg = session.history.find(m => m.id === elementId);
                if (lastAiMsg) {
                    lastAiMsg.text = fullText;
                } else {
                    session.history.push({ role: 'ai', text: fullText, id: elementId });
                }
            },

            addChatMessage(role, text, elementId = null) {
                // Save to current session state
                if (this.currentSubject && this.chatSessions[this.currentSubject]) {
                    this.chatSessions[this.currentSubject].history.push({ role, text, id: elementId });
                }
                this.renderChatMessage(role, text, elementId);
            },

            renderChatMessage(role, text, elementId = null) {
                const history = document.getElementById('chatHistory');
                const div = document.createElement('div');
                div.className = 'flex gap-4 ' + (role === 'user' ? 'flex-row-reverse' : '');

                const avatar = document.createElement('div');
                avatar.className = `w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold text-xs ${role === 'user' ? 'bg-slate-500' : (role === 'system' ? 'bg-red-400' : 'bg-gradient-to-tr from-blue-500 to-purple-500')}`;
                avatar.textContent = role === 'user' ? 'U' : (role === 'system' ? '!' : 'AI');

                const bubble = document.createElement('div');
                bubble.className = `max-w-2xl rounded-2xl p-4 shadow-sm text-sm leading-relaxed border ${role === 'user' ? 'bg-blue-600 text-white rounded-tr-none border-blue-600' : 'bg-white rounded-tl-none text-slate-700 border-slate-100'}`;

                if (elementId) bubble.id = elementId;

                if (role === 'user') { bubble.textContent = text; }
                else { bubble.innerHTML = window.marked.parse(text); }
                div.appendChild(avatar);
                div.appendChild(bubble);
                history.appendChild(div);
                history.scrollTop = history.scrollHeight;
            },

            showTypingIndicator() {
                const history = document.getElementById('chatHistory');
                const div = document.createElement('div');
                div.id = 'typingIndicator';
                div.className = 'flex gap-4';
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex-shrink-0 flex items-center justify-center text-white font-bold text-xs">AI</div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-sm border border-slate-100 flex items-center gap-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    </div>`;
                history.appendChild(div);
                history.scrollTop = history.scrollHeight;
            },

            removeTypingIndicator() {
                const el = document.getElementById('typingIndicator');
                if (el) el.remove();
            }
        };
        window.onload = () => app.init();
    </script>
</body>

</html>